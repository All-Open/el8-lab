lab_desc="Module streams and waterfalls :)"

setup () {
    echo
    echo
    echo -n "Please stay patient - it can take a while"
    yum module -y enable swig >/dev/null 2>/dev/null
    echo -n "."
    yum module -y install squid >/dev/null 2>/dev/null
    echo -n "."
    yum module -y install redis >/dev/null 2>/dev/null
    echo -n "."
    yum module -y disable redis >/dev/null 2>/dev/null
    echo -n "."
    yum module -y install mysql >/dev/null 2>/dev/null
    status_ok
}

grade () {
    echo "disable_php reset_swig install_subversion_server updatable_redis remove_squid install_custodia install_galera"
}

disable_php_desc="php should not be listed by 'yum list'"
disable_php () {
    yum list php 2>&1 | grep -q "No matching Packages"
}

reset_swig_desc="swig module should be neither enabled nor disabled"
reset_swig () {
    if [ ! -e /etc/dnf/modules.d/swig.module ]; then
        return 0
    fi

    grep -q "^state=$" /etc/dnf/modules.d/swig.module
}

install_subversion_server_desc="Install subversion server"
install_subversion_server () {
    is_package_installed mod_dav_svn
}

updatable_redis_desc="Make sure redis will be updated during the next system update"
updatable_redis () {
    yum module list | grep redis | grep -q '\[x\]' && return 1

    return 0
}

remove_squid_desc="Remove squid module with all its packages"
remove_squid () {
    is_package_installed squid && return 1
    is_package_installed libecap && return 1
    grep -q "^state=enabled" /etc/dnf/modules.d/squid.module && return 1

    return 0
}

install_custodia_desc="Install custodia (idm secret provider) package"
install_custodia () {
    is_package_installed custodia
}

install_galera_desc="Install galera profile in a clean way"
install_galera () {
    # "Clean" meaning - remove mysql and disable module first

    is_package_installed mysql-server && return 1
    ! is_package_installed galera && return 1
    grep -q "^state=enabled" /etc/dnf/modules.d/mysql.module && return 1

    return 0
}
